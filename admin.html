<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Page</title>
  <style>
    form {
      max-width: 400px;
      margin: 20px auto;
      display: flex;
      flex-direction: column;
    }
    label {
      margin: 10px 0 5px;
    }
    input, select, button {
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <h1>Admin Page</h1>
  <div id="login-section">
    <label for="admin-password">Set Admin Password:</label>
    <input type="password" id="admin-password">
    <button id="set-password">Set Password</button>
  </div>
  <div id="form-section" style="display: none;">
    <form id="data-entry-form">
      <label for="loft">Loft:</label>
      <select id="loft"></select>
      
      <label for="pigeon-number">Pigeon Number:</label>
      <input type="number" id="pigeon-number" readonly>
      
      <label for="time">Time (HH:MM:SS):</label>
      <input type="text" id="time" placeholder="HH:MM:SS" pattern="^([0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$" title="Time must be in HH:MM:SS format (24-hour)" required>
      
      <button type="button" id="save-button">Save</button>
      
      <label for="uraan-time">Uraan Ka Time (HH:MM:SS):</label>
      <input type="text" id="uraan-time" placeholder="HH:MM:SS" pattern="^([0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$" title="Time must be in HH:MM:SS format (24-hour)" required>
      <button type="button" id="apply-uraan-time">Apply</button>
    </form>
  </div>
  <script>
    const passwordInput = document.getElementById('admin-password');
    const setPasswordButton = document.getElementById('set-password');
    const formSection = document.getElementById('form-section');
    const loginSection = document.getElementById('login-section');

    let adminPassword = localStorage.getItem('adminPassword');

    if (adminPassword) {
      loginSection.style.display = 'none';
      formSection.style.display = 'block';
    }

    setPasswordButton.addEventListener('click', () => {
      adminPassword = passwordInput.value;
      localStorage.setItem('adminPassword', adminPassword);
      loginSection.style.display = 'none';
      formSection.style.display = 'block';
    });

    const loftSelect = document.getElementById('loft');
    const pigeonNumberInput = document.getElementById('pigeon-number');
    const timeInput = document.getElementById('time');
    const saveButton = document.getElementById('save-button');
    const uraanTimeInput = document.getElementById('uraan-time');
    const applyUraanButton = document.getElementById('apply-uraan-time');

    // Populate dropdown with Loft options
    for (let i = 1; i <= 10; i++) {
      const option = document.createElement('option');
      option.value = `Loft ${i}`;
      option.textContent = `Loft ${i}`;
      loftSelect.appendChild(option);
    }

    // Dynamically update pigeon number based on selected loft
    loftSelect.addEventListener('change', () => {
      const selectedLoft = loftSelect.value;
      const table = window.opener.document.querySelector('#main-table');
      const rows = table.querySelectorAll('tbody tr');
      let nextPigeon = 1;
      rows.forEach(row => {
        if (row.cells[0].textContent === selectedLoft) {
          for (let i = 1; i <= 7; i++) {
            if (!row.cells[i].textContent) {
              nextPigeon = i;
              break;
            }
          }
        }
      });
      pigeonNumberInput.value = nextPigeon;
    });

    // Save the entered time into the table
    saveButton.addEventListener('click', () => {
      const selectedLoft = loftSelect.value;
      const pigeonNumber = pigeonNumberInput.value;
      const timeValue = timeInput.value;

      // Validate time format
      if (!isValidTimeFormat(timeValue)) {
        alert('Please enter a valid time in HH:MM:SS format (24-hour).');
        return;
      }

      const table = window.opener.document.querySelector('#main-table');
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        if (row.cells[0].textContent === selectedLoft) {
          row.cells[parseInt(pigeonNumber)].textContent = timeValue;
        }
      });
    });

    // Apply Uraan Ka Time
    applyUraanButton.addEventListener('click', () => {
      const uraanTimeValue = uraanTimeInput.value;

      // Validate time format
      if (!isValidTimeFormat(uraanTimeValue)) {
        alert('Please enter a valid Uraan time in HH:MM:SS format (24-hour).');
        return;
      }

      const table = window.opener.document.querySelector('#main-table');
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        let total = 0;
        for (let i = 1; i <= 7; i++) {
          const cellValue = row.cells[i].textContent;
          if (cellValue) {
            const [h1, m1, s1] = cellValue.split(':').map(Number);
            const [h2, m2, s2] = uraanTimeValue.split(':').map(Number);
            const timeInSeconds = (h1 * 3600 + m1 * 60 + s1) - (h2 * 3600 + m2 * 60 + s2);
            row.cells[i].textContent = new Date(timeInSeconds * 1000).toISOString().substr(11, 8);
            total += timeInSeconds;
          }
        }
        row.cells[8].textContent = new Date(total * 1000).toISOString().substr(11, 8);
      });
    });

    // Function to validate time format
    function isValidTimeFormat(time) {
      const timeRegex = /^([0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;
      return timeRegex.test(time);
    }
  </script>
</body>
</html>
