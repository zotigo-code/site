<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    h1 { margin-bottom:10px; }
    fieldset { border:1px solid #aaa; padding:15px; margin-bottom:20px; border-radius:8px; }
    legend { font-weight:bold; }
    label { display:block; margin-top:10px; }
    input, select, button { margin-top:5px; padding:5px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="loginSection">
    <h1>Admin Login</h1>
    <label for="adminPassword">Password:</label>
    <input type="password" id="adminPassword">
    <br>
    <button id="loginBtn">Login</button>
    <button id="setPasswordBtn">Set Password</button>
  </div>

  <!-- Main Admin Section -->
  <div id="formSection" class="hidden">
    <h1>Admin Panel</h1>

    <fieldset>
      <legend>Create Tournament</legend>
      <label>Number of Pigeons:<input type="number" id="pigeonCount"></label>
      <button id="createTournamentBtn">Create Tournament</button>
    </fieldset>

    <fieldset>
      <legend>Page Heading</legend>
      <input type="text" id="pageHeadingInput" placeholder="Enter page heading">
      <br>
      <button id="setPageHeadingBtn">Save Heading</button>
      <button id="removePageHeadingBtn">Remove Heading</button>
    </fieldset>

    <fieldset>
      <legend>Top Banner Image</legend>
      <input type="file" id="imageUpload" accept="image/*">
      <br>
      <button id="setImageBtn">Save Image</button>
      <button id="removeImageBtn">Remove Image</button>
    </fieldset>

    <fieldset>
      <legend>Sab Lofts Ka Uraan Ka Time</legend>
      <input type="text" id="uraanKaTime" placeholder="HH:MM:SS">
      <br>
      <button id="applyUraanTimeBtn">Apply</button>
    </fieldset>

    <fieldset>
      <legend>Add New Loft</legend>
      <label>Name:<input type="text" id="rowName"></label>
      <button id="addRowBtn">Add Row</button>
    </fieldset>

    <fieldset>
      <legend>Save Pigeon Time</legend>
      <label for="nameSelect">Name:</label>
      <select id="nameSelect"></select>

      <label for="pigeonNumber">Pigeon #:</label>
      <select id="pigeonNumber"></select>

      <label for="timeInput">Pigeon Time (HH:MM:SS):</label>
      <input type="text" id="timeInput" placeholder="HH:MM:SS">
      <br>
      <button id="saveBtn">Save Time</button>
    </fieldset>

    <fieldset>
      <legend>Set Uraan Ka Time for Individual Loft</legend>
      <label for="uraanTimeByName">Uraan Ka Time (HH:MM:SS):</label>
      <input type="text" id="uraanTimeByName">
      <br>
      <button id="applyUraanTimeByNameBtn">Apply for Selected Name</button>
    </fieldset>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- Helpers ---
      function autoFormatTime(input){
        input.addEventListener("input", ()=>{
          let v=input.value.replace(/\D/g,"").slice(0,6);
          if(v.length>=4){ v=v.replace(/(\d{2})(\d{2})(\d{0,2})/,"$1:$2:$3"); }
          else if(v.length>=2){ v=v.replace(/(\d{2})(\d{0,2})/,"$1:$2"); }
          input.value=v;
        });
      }
      autoFormatTime(document.getElementById("uraanKaTime"));
      autoFormatTime(document.getElementById("timeInput"));
      autoFormatTime(document.getElementById("uraanTimeByName"));

      // --- Tournament creation ---
      document.getElementById("createTournamentBtn").addEventListener("click", () => {
        archiveCurrentTournament();
        const pigeons = parseInt(document.getElementById("pigeonCount").value);
        localStorage.setItem("tournamentConfig", JSON.stringify({ pigeons }));
        localStorage.setItem("tournamentRows", JSON.stringify([]));
        alert(`New tournament created with ${pigeons} pigeons.`);
        renderNameDropdown();
      });

      // --- Page heading ---
      document.getElementById("setPageHeadingBtn").addEventListener("click", () => {
        localStorage.setItem("pageHeading", document.getElementById("pageHeadingInput").value);
        alert("Heading updated");
      });
      document.getElementById("removePageHeadingBtn").addEventListener("click", () => {
        localStorage.removeItem("pageHeading");
        alert("Heading removed");
      });

      // --- Banner image ---
      document.getElementById("setImageBtn").addEventListener("click", () => {
        const f = document.getElementById("imageUpload").files[0];
        if (!f) return alert("No file selected");
        const r = new FileReader();
        r.onload = e => {
          localStorage.setItem("topImage", e.target.result);
          alert("Image updated");
        };
        r.readAsDataURL(f);
      });
      document.getElementById("removeImageBtn").addEventListener("click", () => {
        localStorage.removeItem("topImage");
        alert("Image removed");
      });

      // --- Global Uraan Ka Time ---
      document.getElementById("applyUraanTimeBtn").addEventListener("click", () => {
        localStorage.setItem("uraanKaTime", document.getElementById("uraanKaTime").value);
        alert("Sab Lofts Ka Uraan Ka Time set");
      });

      // --- Add Row ---
      document.getElementById("addRowBtn").addEventListener("click", () => {
        const config = JSON.parse(localStorage.getItem("tournamentConfig"));
        if (!config) return alert("No tournament created yet.");
        const name = document.getElementById("rowName").value.trim();
        if (!name) return alert("Please enter a name.");

        const rows = JSON.parse(localStorage.getItem("tournamentRows")) || [];
        rows.push({ name, times: Array(config.pigeons).fill("") });
        localStorage.setItem("tournamentRows", JSON.stringify(rows));

        alert("Row added");
        document.getElementById("rowName").value = "";
        renderNameDropdown();
      });

      // --- Dropdowns ---
      function renderNameDropdown() {
        const nameSelect = document.getElementById("nameSelect");
        const rows = JSON.parse(localStorage.getItem("tournamentRows")) || [];
        nameSelect.innerHTML = "";
        rows.forEach((r, idx) => {
          nameSelect.add(new Option(r.name, idx));
        });
        if (rows.length > 0) updatePigeonDropdown(0);
      }
      function updatePigeonDropdown(rowIndex) {
        const config = JSON.parse(localStorage.getItem("tournamentConfig"));
        const rows = JSON.parse(localStorage.getItem("tournamentRows")) || [];
        const pigeonDropdown = document.getElementById("pigeonNumber");
        pigeonDropdown.innerHTML = "";
        if (!config || !rows[rowIndex]) return;
        rows[rowIndex].times.forEach((t, i) => {
          pigeonDropdown.add(new Option(t ? `Pigeon ${i+1} (Filled)` : `Pigeon ${i+1}`, i));
        });
      }
      document.getElementById("nameSelect").addEventListener("change", (e) => {
        updatePigeonDropdown(e.target.value);
      });

      // --- Save Pigeon Time ---
      document.getElementById("saveBtn").addEventListener("click", () => {
        const rows = JSON.parse(localStorage.getItem("tournamentRows")) || [];
        const rowIdx = document.getElementById("nameSelect").value;
        const pigeonIdx = document.getElementById("pigeonNumber").value;
        const time = document.getElementById("timeInput").value;

        if (!/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(time))
          return alert("Invalid format. Use HH:MM:SS");

        rows[rowIdx].times[pigeonIdx] = time;
        localStorage.setItem("tournamentRows", JSON.stringify(rows));

        alert("Time saved!");
        document.getElementById("timeInput").value = "";
        updatePigeonDropdown(rowIdx);
      });

      // --- Per-name Uraan Ka Time ---
      document.getElementById("applyUraanTimeByNameBtn").addEventListener("click", () => {
        const rows = JSON.parse(localStorage.getItem("tournamentRows")) || [];
        const rowIdx = document.getElementById("nameSelect").value;
        const uraanTime = document.getElementById("uraanTimeByName").value;

        if (!/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(uraanTime))
          return alert("Invalid format. Use HH:MM:SS");

        rows[rowIdx].uraanTimeByName = uraanTime;
        localStorage.setItem("tournamentRows", JSON.stringify(rows));
        alert("Uraan Ka Time saved for " + rows[rowIdx].name);
        document.getElementById("uraanTimeByName").value = "";
      });

      renderNameDropdown();
    });

    // --- Secure Login ---
    document.addEventListener("DOMContentLoaded", () => {
      const savedPass = localStorage.getItem("adminPassword");
      if (savedPass) {
        document.getElementById("setPasswordBtn").style.display = "none";
      }
      document.getElementById("setPasswordBtn").addEventListener("click", () => {
        const pass = document.getElementById("adminPassword").value;
        if (!pass) return alert("Enter a password");
        if (savedPass) return alert("Password already set. Cannot reset here.");
        localStorage.setItem("adminPassword", pass);
        alert("Password set successfully. Please login now.");
      });
      document.getElementById("loginBtn").addEventListener("click", () => {
        const pass = document.getElementById("adminPassword").value;
        const saved = localStorage.getItem("adminPassword");
        if (pass === saved) {
          document.getElementById("loginSection").style.display = "none";
          document.getElementById("formSection").style.display = "block";
        } else {
          alert("Wrong password");
        }
      });
    });

    // --- Archive tournaments ---
    function archiveCurrentTournament() {
      const rows = JSON.parse(localStorage.getItem("tournamentRows")) || [];
      const config = localStorage.getItem("tournamentConfig");
      if (rows.length || config) {
        const archive = JSON.parse(localStorage.getItem("tournamentArchive")) || [];
        archive.push({ rows, config, date: new Date().toISOString() });
        localStorage.setItem("tournamentArchive", JSON.stringify(archive));
      }
    }
  </script>
</body>
</html>
