<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Current Tournament</title>
  <style>
    #topImageContainer { width:100%; height:20vh; overflow:hidden; margin-bottom:10px; }
    #topImageContainer img { width:100%; height:100%; object-fit:cover; }
    h1 { background:lightblue; text-align:center; font-size:2rem; padding:10px; margin-bottom:20px; position:relative; }
    #prevBtn { position:absolute; right:10px; top:10px; }
    table { border-collapse:collapse; width:100%; table-layout:fixed; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:lightcoral; color:white; }
    tbody tr:nth-child(even){ background:#f0f8ff; }

    /* ✅ Blink effect */
    .blink {
      animation: blink-animation 1s infinite alternate;
      background-color: lightgreen;
    }
    @keyframes blink-animation {
      from { background-color: lightgreen; }
      to { background-color: transparent; }
    }

    .stats { display:flex; justify-content:space-between; margin-bottom:15px; }
  </style>
</head>
<body>
  <div id="topImageContainer"></div>
  <h1 id="pageHeading">Tournament 
    <a href="previous.html"><button id="prevBtn">Previous Tournaments</button></a>
  </h1>

  <div class="stats">
    <div><strong>First Pigeon Landed:</strong> <span id="firstPigeonLanded">N/A</span></div>
    <div><strong>Last Pigeon Landed:</strong> <span id="lastPigeonLanded">N/A</span></div>
    <div><strong>Total Number of Pigeons:</strong> <span id="totalPigeons">0</span></div>
    <div><strong>Sab Lofts Ka Uraan Ka Time:</strong> <span id="uraanKaTimeDisplay">00:00:00</span></div>
  </div>

  <table id="mainTable"><thead></thead><tbody></tbody></table>

  <script>
    function parseTime(t){if(!t)return null;const [h,m,s]=t.split(":").map(Number);return h*3600+m*60+s;}
    function fmt(sec){if(sec<=0)return"";const h=String(Math.floor(sec/3600)).padStart(2,"0");const m=String(Math.floor((sec%3600)/60)).padStart(2,"0");const s=String(sec%60).padStart(2,"0");return `${h}:${m}:${s}`;}

    function renderTable(){
      const config=JSON.parse(localStorage.getItem("tournamentConfig"));
      const rows=JSON.parse(localStorage.getItem("tournamentRows"))||[];
      const uraan=localStorage.getItem("uraanKaTime")||"00:00:00";
      const heading=localStorage.getItem("pageHeading")||"Tournament";
      const image=localStorage.getItem("topImage");

      document.getElementById("pageHeading").childNodes[0].textContent=heading+" ";
      document.getElementById("uraanKaTimeDisplay").textContent=uraan;

      const head=document.querySelector("#mainTable thead");
      const body=document.querySelector("#mainTable tbody");
      head.innerHTML=""; body.innerHTML="";
      if(!config)return;

      let thRow="<tr><th>#</th><th>Name</th>";
      for(let i=1;i<=config.pigeons;i++) thRow+=`<th>${i}</th>`;
      thRow+="<th>Total</th></tr>";
      head.innerHTML=thRow;

      let allTimes=[];

      rows.forEach(r=>{
        r.times.forEach(t=>{ if(t) allTimes.push(t); });
      });

      let latestTime = null;
      if(allTimes.length>0){
        allTimes.sort();
        document.getElementById("firstPigeonLanded").textContent=allTimes[0];
        document.getElementById("lastPigeonLanded").textContent=allTimes[allTimes.length-1];
        latestTime = allTimes[allTimes.length-1]; // ✅ track latest
      } else {
        document.getElementById("firstPigeonLanded").textContent="N/A";
        document.getElementById("lastPigeonLanded").textContent="N/A";
      }
      document.getElementById("totalPigeons").textContent=rows.length * (config ? config.pigeons : 0);

      rows.forEach((r,idx)=>{
        let row=`<tr><td>${idx+1}</td><td>${r.name}</td>`;
        let total=0;
        r.times.forEach(t=>{
          if(t){
            const diff=parseTime(t)-parseTime(uraan);
            total+=diff;
            row+=`<td class="${t===latestTime ? "blink" : ""}">${t}</td>`;
          } else {
            row+=`<td></td>`;
          }
        });
        row+=`<td>${fmt(total)}</td></tr>`;
        body.innerHTML+=row;
      });

      if(image)document.getElementById("topImageContainer").innerHTML=`<img src="${image}">`;
    }

    document.addEventListener("DOMContentLoaded", renderTable);
    window.addEventListener("storage", renderTable);
  </script>
</body>
</html>
