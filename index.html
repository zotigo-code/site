<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main Table</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #topImageContainer { width: 100%; height: 20vh; overflow: hidden; margin-bottom: 10px; }
    #topImageContainer img { width: 100%; height: 100%; object-fit: cover; }
    h1 { background-color: lightblue; text-align: center; font-size: 2rem; padding: 10px; margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    th, td { border: 1px solid #ddd; text-align: center; padding: 8px; width: 10%; }
    th { background-color: lightcoral; color: white; }
    .blink { animation: blink-animation 1s infinite alternate; background-color: lightgreen; }
    @keyframes blink-animation { from { background-color: lightgreen; } to { background-color: transparent; } }
    footer { position: fixed; bottom: 10px; left: 10px; font-size: 0.9rem; color: grey; }
  </style>
</head>
<body>
  <div id="topImageContainer"></div>
  <h1 id="pageHeading">Loft Times Table</h1>

  <div id="tableStats" style="display:flex; justify-content:space-between; margin-bottom:20px;">
    <div>
      <strong>First Pigeon Landed:</strong> <span id="firstPigeonLanded">N/A</span>
      <strong>Last Pigeon Landed:</strong> <span id="lastPigeonLanded">N/A</span>
    </div>
    <div><strong>Total Number of Pigeons:</strong> <span id="totalPigeons">70</span></div>
    <div><strong>Sab Lofts Ka Uraan Ka Time:</strong> <span id="uraanKaTimeDisplay">00:00:00</span></div>
  </div>

  <table id="mainTable">
    <thead>
      <tr>
        <th>Loft</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer id="lastUpdated">Last Updated: N/A</footer>

  <script>
    let loftData, uraanKaTime, perLoftUraanKaTime, pageHeading, lastUpdated, latestTime;

    function loadData() {
      loftData = JSON.parse(localStorage.getItem("loftData")) || Array(10).fill(null).map(() => Array(7).fill(""));
      uraanKaTime = localStorage.getItem("uraanKaTime") || "00:00:00";
      perLoftUraanKaTime = JSON.parse(localStorage.getItem("perLoftUraanKaTime")) || {};
      pageHeading = localStorage.getItem("pageHeading") || "Loft Times Table";
      lastUpdated = localStorage.getItem("lastUpdated") || "N/A";
    }

    function updateStats() {
      document.getElementById("uraanKaTimeDisplay").textContent = uraanKaTime;
      let firstTime = null; latestTime = null;
      loftData.forEach(loft => {
        loft.forEach(time => {
          if (time) {
            if (!firstTime || time < firstTime) firstTime = time;
            if (!latestTime || time > latestTime) latestTime = time;
          }
        });
      });
      document.getElementById("firstPigeonLanded").textContent = firstTime || "N/A";
      document.getElementById("lastPigeonLanded").textContent = latestTime || "N/A";
      document.getElementById("totalPigeons").textContent = loftData.length * 7;
    }

    function updateMainTable() {
      const tbody = document.querySelector("#mainTable tbody");
      tbody.innerHTML = "";
      loftData.forEach((loft, i) => {
        const row = document.createElement("tr");
        const loftCell = document.createElement("td");

        // Loft Uraan Time if different from global
        let loftTime = perLoftUraanKaTime[i+1] || uraanKaTime;
        loftCell.innerHTML = `Loft ${i+1}`;
        if (perLoftUraanKaTime[i+1] && perLoftUraanKaTime[i+1] !== uraanKaTime) {
          loftCell.innerHTML += `<br><small>Uraan: ${perLoftUraanKaTime[i+1]}</small>`;
        }
        row.appendChild(loftCell);

        let totalSeconds = 0;
        loft.forEach(time => {
          const cell = document.createElement("td");
          if (time) {
            cell.textContent = time;
            if (time === latestTime) cell.classList.add("blink");
            totalSeconds += parseTimeInSeconds(time) - parseTimeInSeconds(loftTime);
          }
          row.appendChild(cell);
        });
        for (let j = loft.length; j < 7; j++) row.appendChild(document.createElement("td"));

        const totalCell = document.createElement("td");
        totalCell.textContent = totalSeconds > 0 ? formatSeconds(totalSeconds) : "";
        row.appendChild(totalCell);

        tbody.appendChild(row);
      });
    }

    function parseTimeInSeconds(t) { const [h,m,s] = t.split(":").map(Number); return h*3600+m*60+s; }
    function formatSeconds(sec) {
      const h = String(Math.floor(sec/3600)).padStart(2,"0");
      const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
      const s = String(sec%60).padStart(2,"0");
      return `${h}:${m}:${s}`;
    }

    function updatePage() {
      loadData();
      document.getElementById("pageHeading").textContent = pageHeading;
      document.getElementById("lastUpdated").textContent = `Last Updated: ${lastUpdated}`;
      updateStats();
      updateMainTable();
      const banner = document.getElementById("topImageContainer");
      banner.innerHTML = "";
      const savedImage = localStorage.getItem("topImage");
      if (savedImage) banner.innerHTML = `<img src="${savedImage}" alt="Top Image">`;
      else banner.style.height = "0px";
    }

    document.addEventListener("DOMContentLoaded", updatePage);
    window.addEventListener("storage", updatePage);
  </script>
</body>
</html>
