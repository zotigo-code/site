<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tournament Results</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; margin-bottom: 10px; }
    .banner { display: block; margin: 0 auto 20px auto; max-width: 100%; height: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    .name-cell { text-align: left; font-weight: bold; }
    .uraan-cell { font-size: 0.85em; color: #555; }
  </style>
</head>
<body>
  <h1 id="pageHeading"></h1>
  <img id="topImage" class="banner" style="display:none;" />

  <p><strong>Sab Lofts Ka Uraan Ka Time:</strong> <span id="globalUraanTime">--:--:--</span></p>

  <table id="resultsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Pigeon #</th>
        <th>Time</th>
        <th>Difference</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function calculateDifference(start, end) {
      const [sh, sm, ss] = start.split(":").map(Number);
      const [eh, em, es] = end.split(":").map(Number);
      const startSec = sh*3600 + sm*60 + ss;
      const endSec = eh*3600 + em*60 + es;
      return endSec - startSec;
    }

    function formatTimeDiff(seconds) {
      if (isNaN(seconds)) return "";
      const h = Math.floor(seconds/3600).toString().padStart(2,"0");
      const m = Math.floor((seconds%3600)/60).toString().padStart(2,"0");
      const s = (seconds%60).toString().padStart(2,"0");
      return `${h}:${m}:${s}`;
    }

    function renderTable() {
      const heading = localStorage.getItem("pageHeading") || "Tournament Results";
      document.getElementById("pageHeading").textContent = heading;

      const img = localStorage.getItem("topImage");
      if (img) {
        document.getElementById("topImage").src = img;
        document.getElementById("topImage").style.display = "block";
      }

      const globalUraan = localStorage.getItem("uraanKaTime") || "--:--:--";
      document.getElementById("globalUraanTime").textContent = globalUraan;

      const rows = JSON.parse(localStorage.getItem("tournamentRows")) || [];
      const config = JSON.parse(localStorage.getItem("tournamentConfig"));
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = "";

      rows.forEach(r => {
        const uraanRef = r.uraanTimeByName || globalUraan;

        let total = 0;
        r.times.forEach((time, idx) => {
          const tr = document.createElement("tr");

          if (idx === 0) {
            const nameTd = document.createElement("td");
            nameTd.className = "name-cell";
            nameTd.rowSpan = r.times.length;
            nameTd.innerHTML = r.name;

            // If custom uraan time exists, show it under the name
            if (r.uraanTimeByName) {
              const small = document.createElement("div");
              small.className = "uraan-cell";
              small.textContent = `(Uraan: ${r.uraanTimeByName})`;
              nameTd.appendChild(small);
            }

            tr.appendChild(nameTd);
          }

          const pigeonTd = document.createElement("td");
          pigeonTd.textContent = `Pigeon ${idx+1}`;
          tr.appendChild(pigeonTd);

          const timeTd = document.createElement("td");
          timeTd.textContent = time || "";
          tr.appendChild(timeTd);

          const diffTd = document.createElement("td");
          if (time) {
            const diff = calculateDifference(uraanRef, time);
            diffTd.textContent = formatTimeDiff(diff);
            total += diff;
          } else {
            diffTd.textContent = "";
          }
          tr.appendChild(diffTd);

          if (idx === 0) {
            const totalTd = document.createElement("td");
            totalTd.rowSpan = r.times.length;
            totalTd.textContent = formatTimeDiff(total);
            tr.appendChild(totalTd);
          }

          tbody.appendChild(tr);
        });
      });
    }

    document.addEventListener("DOMContentLoaded", renderTable);
  </script>
</body>
</html>
