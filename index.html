<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main Table</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Top Image */
    #topImageContainer {
      width: 100%;
      height: 20vh; /* 20% of screen height */
      overflow: hidden;
      margin-bottom: 10px;
    }
    #topImageContainer img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* stretch + crop to fill */
    }

    h1 {
      background-color: lightyellow;
      text-align: center;
      font-size: 2rem;
      padding: 10px;
      margin-bottom: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 8px;
      width: 10%;
      word-wrap: break-word;
    }
    th {
      background-color: lightcoral;
      color: white;
    }

    .blink {
      animation: blink-animation 1s infinite alternate;
      background-color: lightgreen;
    }
    @keyframes blink-animation {
      from { background-color: lightgreen; }
      to { background-color: transparent; }
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    @media screen and (max-width: 768px) {
      table { font-size: 12px; }
      th, td { padding: 6px; }
    }

    footer {
      position: fixed;
      bottom: 10px;
      left: 10px;
      font-size: 0.9rem;
      color: grey;
    }
  </style>
</head>
<body>
  <!-- Top Image -->
  <div id="topImageContainer"></div>

  <!-- Dynamic Page Heading -->
  <h1 id="pageHeading">Loft Times Table</h1>

  <!-- Stats -->
  <div id="tableStats" style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <div>
      <strong>First Pigeon Landed:</strong> <span id="firstPigeonLanded">N/A</span>
      <strong>Last Pigeon Landed:</strong> <span id="lastPigeonLanded">N/A</span>
    </div>
    <div><strong>Total Number of Pigeons Flown:</strong> <span id="totalPigeonsFlown">70</span></div>
    <div><strong>Uraan Ka Time:</strong> <span id="uraanKaTimeDisplay">00:00:00</span></div>
  </div>

  <div class="table-container">
    <table id="mainTable">
      <thead>
        <tr>
          <th>Loft</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>Total</th>
        </tr>
      </thead>
      <tbody>
        <script>
          for (let i = 1; i <= 10; i++) {
            document.write(`<tr>
              <td>Loft ${i}</td>
              ${'<td></td>'.repeat(7)}
              <td></td>
            </tr>`);
          }
        </script>
      </tbody>
    </table>
  </div>

  <footer id="lastUpdated">Last Updated: N/A</footer>

  <script>
    const loftData = JSON.parse(localStorage.getItem("loftData")) || Array(10).fill(null).map(() => Array(7).fill(""));
    const uraanKaTime = localStorage.getItem("uraanKaTime") || "00:00:00";
    const pageHeading = localStorage.getItem("pageHeading") || "Loft Times Table";
    const lastUpdated = localStorage.getItem("lastUpdated") || "N/A";
    let latestTime = null;

    function updateStats() {
      const firstPigeonLanded = document.getElementById("firstPigeonLanded");
      const lastPigeonLanded = document.getElementById("lastPigeonLanded");
      const uraanKaTimeDisplay = document.getElementById("uraanKaTimeDisplay");
      const totalPigeonsFlown = document.getElementById("totalPigeonsFlown");
      uraanKaTimeDisplay.textContent = uraanKaTime;
      let firstTime = null; latestTime = null;
      for (let i = 0; i < loftData.length; i++) {
        for (let j = 0; j < loftData[i].length; j++) {
          const time = loftData[i][j];
          if (time) {
            if (!firstTime || time < firstTime) firstTime = time;
            if (!latestTime || time > latestTime) latestTime = time;
          }
        }
      }
      firstPigeonLanded.textContent = firstTime || "N/A";
      lastPigeonLanded.textContent = latestTime || "N/A";
      totalPigeonsFlown.textContent = loftData.length * 7;
    }

    function updateMainTable() {
      const mainTable = document.getElementById("mainTable").getElementsByTagName("tbody")[0];
      mainTable.innerHTML = "";
      loftData.forEach((loft, i) => {
        const row = document.createElement("tr");
        const loftCell = document.createElement("td");
        loftCell.textContent = `Loft ${i + 1}`;
        row.appendChild(loftCell);
        let totalSeconds = 0;
        loft.forEach((time) => {
          const cell = document.createElement("td");
          if (time) {
            cell.textContent = time;
            if (time === latestTime) cell.classList.add("blink");
            totalSeconds += parseTimeInSeconds(time) - parseTimeInSeconds(uraanKaTime);
          }
          row.appendChild(cell);
        });
        for (let j = loft.length; j < 7; j++) row.appendChild(document.createElement("td"));
        const totalCell = document.createElement("td");
        totalCell.textContent = totalSeconds > 0 ? formatSeconds(totalSeconds) : "";
        row.appendChild(totalCell);
        mainTable.appendChild(row);
      });
    }

    function parseTimeInSeconds(timeStr) {
      const [hh, mm, ss] = timeStr.split(":").map(Number);
      return hh * 3600 + mm * 60 + ss;
    }
    function formatSeconds(seconds) {
      const hh = String(Math.floor(seconds / 3600)).padStart(2, "0");
      const mm = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
      const ss = String(seconds % 60).padStart(2, "0");
      return `${hh}:${mm}:${ss}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("pageHeading").textContent = pageHeading;
      document.getElementById("lastUpdated").textContent = `Last Updated: ${lastUpdated}`;
      updateStats();
      updateMainTable();
      const savedImage = localStorage.getItem("topImage");
      if (savedImage) {
        document.getElementById("topImageContainer").innerHTML =
          `<img src="${savedImage}" alt="Top Image">`;
      }
    });
  </script>
</body>
</html>
